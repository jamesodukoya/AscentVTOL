name: Deploy to Oracle Cloud ARM64

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '.devcontainer/post-create.sh'
      - 'workspace/**'
      - '.github/workflows/deploy-to-oracle.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ORACLE_SSH_KEY }}
      
      - name: Add Oracle host to known_hosts
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
        run: ssh-keyscan -H "$ORACLE_HOST" >> ~/.ssh/known_hosts
      
      - name: Sync project files to Oracle server
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          # Sync .devcontainer (excluding local Dockerfile)
          rsync -avz \
            --exclude='Dockerfile' \
            --exclude='devcontainer.json' \
            -e "ssh" \
            .devcontainer/ \
            $ORACLE_USER@$ORACLE_HOST:~/AscentVTOL/.devcontainer/
          
          # Sync workspace directory
          rsync -avz \
            -e "ssh" \
            workspace/ \
            $ORACLE_USER@$ORACLE_HOST:~/AscentVTOL/workspace/
      
      - name: Build and deploy container on Oracle
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh $ORACLE_USER@$ORACLE_HOST << 'DEPLOY_EOF'
          set -e
          cd ~/AscentVTOL
          
          if [ ! -f .devcontainer/Dockerfile.arm64 ]; then
            echo "ERROR: Dockerfile.arm64 not found on server"
            exit 1
          fi
          
          # Fix workspace ownership for container user (UID 1000)
          sudo chown -R 1000:1000 ~/AscentVTOL/workspace
          
          echo "Building Docker image for ARM64..."
          docker build \
            -f .devcontainer/Dockerfile.arm64 \
            -t ascent_vtol:arm64 \
            --build-arg USERNAME=user \
            --build-arg USER_UID=1000 \
            --build-arg USER_GID=1000 \
            .devcontainer/
          
          docker stop ascent_vtol_container 2>/dev/null || true
          docker rm ascent_vtol_container 2>/dev/null || true
          
          echo "Launching container with persistent workspace volume..."
          docker run -d \
            --name ascent_vtol_container \
            -v ~/AscentVTOL/workspace:/home/user/workspace \
            --privileged \
            --network=host \
            ascent_vtol:arm64 \
            sleep infinity
          
          echo "Running post-create setup..."
          docker exec ascent_vtol_container \
            bash /home/user/.devcontainer/post-create.sh
          
          echo "âœ“ Deployment complete"
          DEPLOY_EOF
      
      - name: Verify deployment
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh $ORACLE_USER@$ORACLE_HOST << 'VERIFY_EOF'
          echo "=== Docker Images ==="
          docker images | grep ascent_vtol
          
          echo ""
          echo "=== Running Containers ==="
          docker ps | grep ascent_vtol_container
          
          echo ""
          echo "=== Workspace Contents ==="
          ls -lah ~/AscentVTOL/workspace/
          VERIFY_EOF
