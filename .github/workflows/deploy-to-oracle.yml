name: Deploy to Oracle Cloud ARM64

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '.devcontainer/post-create.sh'
      - 'workspace/**'
      - '.github/workflows/deploy-to-oracle.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.ORACLE_SSH_KEY }}
      
      - name: Add Oracle host to known_hosts
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
        run: ssh-keyscan -H "$ORACLE_HOST" >> ~/.ssh/known_hosts
      
      - name: Setup workspace directory on server
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh $ORACLE_USER@$ORACLE_HOST << 'SETUP_EOF'
          mkdir -p ~/AscentVTOL/workspace
          sudo chown -R $(whoami):$(whoami) ~/AscentVTOL/workspace
          SETUP_EOF
      
      - name: Sync project files to Oracle server
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          # Sync .devcontainer (excluding local Dockerfile)
          rsync -avz \
            --exclude='Dockerfile' \
            --exclude='devcontainer.json' \
            -e "ssh" \
            .devcontainer/ \
            $ORACLE_USER@$ORACLE_HOST:~/AscentVTOL/.devcontainer/
          
          # Sync workspace directory
          rsync -avz \
            -e "ssh" \
            workspace/ \
            $ORACLE_USER@$ORACLE_HOST:~/AscentVTOL/workspace/
      
      - name: Build and deploy container on Oracle
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh $ORACLE_USER@$ORACLE_HOST << 'DEPLOY_EOF'
          set -e
          cd ~/AscentVTOL
          
          if [ ! -f .devcontainer/Dockerfile.arm64 ]; then
            echo "ERROR: Dockerfile.arm64 not found on server"
            exit 1
          fi
          
          # Fix workspace ownership for container user (UID 1000)
          sudo chown -R 1000:1000 ~/AscentVTOL/workspace
          
          echo "Building Docker image for ARM64..."
          docker build \
            -f .devcontainer/Dockerfile.arm64 \
            -t ascent_vtol:arm64 \
            --build-arg USERNAME=user \
            --build-arg USER_UID=1000 \
            --build-arg USER_GID=1000 \
            .devcontainer/
          
          docker stop ascent_vtol_container 2>/dev/null || true
          docker rm ascent_vtol_container 2>/dev/null || true
          
          echo "Launching container with persistent workspace volume..."
          docker run -d \
            --name ascent_vtol_container \
            -v ~/AscentVTOL/workspace:/home/user/workspace \
            --privileged \
            --network=host \
            ascent_vtol:arm64 \
            sleep infinity
          
          echo "Running post-create setup..."
          docker exec ascent_vtol_container \
            bash /home/user/.devcontainer/post-create.sh
          
          echo "✓ Container deployment complete"
          DEPLOY_EOF
      
      - name: Stop any existing simulation processes
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh $ORACLE_USER@$ORACLE_HOST << 'STOP_EOF'
          echo "Stopping any existing simulation processes..."
          docker exec ascent_vtol_container pkill -f "px4 -i" 2>/dev/null || true
          docker exec ascent_vtol_container pkill -f commander 2>/dev/null || true
          docker exec ascent_vtol_container pkill -f spawn_three 2>/dev/null || true
          sleep 3
          STOP_EOF
      
      - name: Launch perpetual simulation (spawn vehicles)
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh $ORACLE_USER@$ORACLE_HOST << 'SPAWN_EOF'
          set -e
          
          echo "Starting perpetual vehicle simulation..."
          
          docker exec -d ascent_vtol_container bash -c "
            while true; do
              cd ~/workspace/axon_c2_simulation/launch
              bash spawn_three_vehicles_sitl.sh
              echo '[spawn_vehicles] Restarting in 5 seconds...'
              sleep 5
            done
          " > /tmp/spawn_vehicles.log 2>&1 &
          
          SPAWN_PID=$!
          echo "✓ Vehicle spawner started (PID: $SPAWN_PID)"
          echo "  Log: docker exec ascent_vtol_container tail -f /tmp/spawn_vehicles.log"
          
          SPAWN_EOF
      
      - name: Wait for vehicles to initialize
        run: sleep 25
      
      
      - name: Verify deployment
        env:
          ORACLE_HOST: ${{ secrets.ORACLE_HOST }}
          ORACLE_USER: ${{ secrets.ORACLE_USER }}
        run: |
          ssh $ORACLE_USER@$ORACLE_HOST << 'VERIFY_EOF'
          
          echo ""
          echo "=================================="
          echo "  DEPLOYMENT VERIFICATION"
          echo "=================================="
          
          echo ""
          echo "=== Docker Container Status ==="
          docker ps | grep ascent_vtol_container
          
          echo ""
          echo "=== PX4 Vehicle Status ==="
          VEHICLE_COUNT=$(docker exec ascent_vtol_container bash -c "ps aux | grep 'px4 -i' | grep -v grep | wc -l" || echo "0")
          echo "Running PX4 instances: $VEHICLE_COUNT"
          
          echo ""
          echo "=== Simulation Logs (Latest 5 lines) ==="
          echo "--- Vehicle 1 ---"
          docker exec ascent_vtol_container bash -c "tail -2 /tmp/px4_1.log" || echo "Log not available yet"
          
          echo ""
          echo "--- Spawn Vehicles Log ---"
          docker exec ascent_vtol_container bash -c "tail -2 /tmp/spawn_vehicles.log" || echo "Log not available yet"
          
          echo ""
          echo "--- Commander Log ---"
          docker exec ascent_vtol_container bash -c "tail -2 /tmp/commander.log" || echo "Log not available yet"
          
          echo ""
          echo "=== Workspace Status ==="
          ls -lah ~/AscentVTOL/workspace/ | head -12
          
          echo ""
          echo "=================================="
          echo "  ✓ DEPLOYMENT COMPLETE"
          echo "=================================="
          echo ""
          echo "Monitor simulation:"
          echo "  docker exec ascent_vtol_container tail -f /tmp/px4_1.log"
          echo ""
          echo "Monitor spawner:"
          echo "  docker exec ascent_vtol_container tail -f /tmp/spawn_vehicles.log"
          echo ""
          echo "Monitor commander:"
          echo "  docker exec ascent_vtol_container tail -f /tmp/commander.log"
          echo ""
          
          VERIFY_EOF
